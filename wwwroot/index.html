<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Photon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href='https://fonts.googleapis.com/css?family=Amaranth' rel='stylesheet'>

    <script type="module">
        import { createApp, reactive } from 'https://unpkg.com/petite-vue?module'

        const app = reactive({

            entityType: {},
            view: {},
            views: [],
            viewsPage: 0,
            viewSearch: '',
            indexType: {},
            indexTypePage: 0,
            indexes: [],
            indexesPage: 0,
            indexSearch: '',
            entityTypes: [],
            entityId: 0,
            values: [],
            idValues: [],
            page: 0,
            nPages: 0,
            userStarter: null,
            pwd: "",
            loginMessage: "",
            loadMessage: "",
            menu: null,
            menuHistory: [],
            row: 0,
            mode: 0,
            isAdvanced: false,
            renderKey: 0,
            isConfig: false,
            attributeConfig: { id: 0 },
            lookupsPage: 0,
            nextLookups() {
                this.lookupsPage++
                this.getLookups()
            },
            previousLookups() {
                this.lookupsPage--
                this.getLookups()
            },
            get viewStart() {
                return this.viewsPage * 19
            },
            get viewEnd() {
                return this.viewStart + 19;
            },
            // methods
            logout() {
                this.loginMessage = "";
                this.userStarter = null;
                this.menuHistory = [];
                this.mode = 0;
                this.pwd = "";
            },
            tryLogin() {
                let pwd = this.pwd
                if (pwd.length == 0) {
                    this.authenticated = false;
                    this.loginMessage = "You must enter a password";
                    return;
                }
                this.loginMessage = 'Checking password..'
                fetchWrapper
                    .post('login', { password: this.pwd })
                    .then((values) => {
                        if (values == null) {
                            this.loginMessage = 'Invalid password'
                        } else {
                            this.loginMessage = "Login succeeded. Loading..";
                            this.userStarter = values.userStarter
                            fetchWrapper.token = values.token
                            this.getEntityTypes();
                            this.goHome()
                            resetLoginTimer()
                        }
                    })
                    .catch((error) => console.error(error));

            },
            getEntityTypes() {
                fetchWrapper
                    .get('EntityTypes')
                    .then(data => {
                        this.entityTypes = data
                        this.setEntityType(this.entityTypes.find(e => e.id == 1))
                    })
                    .catch((error) => console.log('error1' + error));
            },
            getLookups() {
                fetchWrapper
                    .get('Lookups/' + this.attributeConfig.id + ',' + this.lookupsPage + ',14')
                    .then(data => {
                        this.attributeConfig.lookups = data
                    })
                    .catch((error) => console.log('error1' + error));
            },
            setEntityType(entityType) {
                if (entityType !== this.entityType) {
                    this.entityType = entityType
                    this.setIndexType(this.entityType.indexTypes.find(t => t.id == this.entityType.defaultIndexTypeId))
                    this.viewsPage = 0;
                    this.indexesPage = 0;
                    this.indexTypePage = 0;
                    this.viewSearch = '';
                    this.indexSearch = '';
                    this.clear()
                    this.mode = 1
                    this.getIndexes()
                    this.getViews()
                }
            },
            setIndexType(indexType) {
                this.indexType = indexType
            },
            async getIndexes() {
                if (this.indexSearch.length >= 3) {
                    await fetchWrapper
                        .get('Indexes/' + this.indexType.id + ',' + this.indexesPage + ',19' + '/' + this.indexSearch)
                        .then((data) => {
                            this.indexes = data
                        })
                        .catch((error) => console.error(error));
                    if (indexTimer) {
                        clearTimeout(indexTimer)
                    }
                    indexTimer = setTimeout(() => {
                        this.indexesPage = 0;
                        this.indexSearch = ''
                        this.indexes = []
                    }, 100000);

                } else this.indexes = []
            },
            async nextIndex() {
                let index = this.indexes.find(i => i.entityId == this.entityId)
                let ix = this.indexes.indexOf(index)

                if (ix < this.indexes.length - 1) {
                    let newIndex = this.indexes[ix + 1]
                    this.setEntity(newIndex.entityId)
                } else if (ix == 18) {
                    await this.getIndexNextPage()
                    if (this.indexes.some(Boolean)) {
                        this.setEntity(this.indexes[0].entityId)
                    }
                }
            },
            async previousIndex() {
                let index = this.indexes.find(i => i.entityId == this.entityId)
                let ix = this.indexes.indexOf(index)

                if (ix > 0) {
                    let newIndex = this.indexes[ix - 1]
                    this.setEntity(newIndex.entityId)
                } else {
                    await this.getIndexPreviousPage()
                    if (this.indexes.some(Boolean)) {
                        this.setEntity(this.indexes[this.indexes.length - 1].entityId)
                    }
                }
            },
            async getIndexNextPage() {
                this.indexesPage++
                await this.getIndexes();
            },
            async getIndexPreviousPage() {
                this.indexesPage--
                await this.getIndexes();
            },
            nextPage() {
                if (this.page < this.nPages - 1) {
                    this.page++;
                    this.getMainValues()
                }
            },
            previousPage() {
                if (this.page > 0) {
                    this.page--;
                    this.getMainValues()
                }
            },
            graph(attributeId) {
                if (this.isConfig) {
                    this.mode = 5
                    this.getAttributeConfig(attributeId)
                    return;
                }
            },
            async getAttributeConfig(attributeId) {
                this.loadMessage="loading.."
                fetchWrapper
                    .get('AttributeConfig/' + attributeId)
                    .then((data) => {
                        this.attributeConfig = data
                        this.lookupsPage = 0
                        this.loadMessage = null
                    })
                    .catch((error) => console.error(error));
            },

            async getMainValues() {
                fetchWrapper
                    .get('ViewValues/' + this.view.id + ',' + this.entityId + ',' + this.page)
                    .then((values) => this.values = values)
                    .catch((error) => console.error(error));
            },

            async getIdValues() {
                fetchWrapper
                    .get('ViewValues/' + this.entityType.idlineViewId + ',' + this.entityId + ',0')
                    .then((values) => this.idValues = values)
                    .catch((error) => console.error(error));
            },
            getViews() {
                let search = this.viewSearch
                this.viewsPage = 0;
                this.menuHistory = []

                if (typeof search === "string" && search.length > 0) {
                    console.log(this.entityType.name)
                    this.views = this.entityType.views.filter(v => v.captions.some(c => c.text.toLowerCase().includes(search.toLowerCase())));

                    return;
                }
                this.views = this.entityType.views;
                this.renderKey++
            },
            indexSearchChanged() {
                //debounce
                let timer = setTimeout(() => {
                    this.indexesPage = 0;
                    this.getIndexes();
                }, 500);
            },
            setView(view) {
                this.view = view
                this.page = 0
                if (this.view.isDated && this.menu.menuItems.length === 0) {
                    this.menu.menuItems.push({ "name": "Up screen", "function": "2", "seq": 1, "nextMenuId": 0, "startMenuId": 0 })
                    this.menu.menuItems.push({ "name": "Down screen", "function": "3", "seq": 2, "nextMenuId": 0, "startMenuId": 0 })
                }
                if (this.entityId > 0) {
                    this.getMainValues()
                    this.getNPages()
                }
            },
            setEntity(entityId) {
                this.entityId = entityId
                this.page = 0
                if (indexTimer) {
                    clearTimeout(indexTimer)
                }
                indexTimer = setTimeout(() => {
                    this.indexesPage = 0;
                    this.indexes = []
                    this.indexSearch = ''

                }, 10000);


                if (this.entityId > 0) {
                    this.getIdValues()
                    if (this.view.id > 0) {
                        this.getMainValues()
                        this.getNPages()
                        return
                    }
                }
            },
            getNPages() {
                fetchWrapper
                    .get('NPages/' + this.view.id + ',' + this.entityId)
                    .then((data) => this.nPages = data)
                    .catch((error) => console.error(error));
            },
            getMenu(id) {
                if (id != this.menu.id) {
                   
                    if (id < 0) {
                        if (this.menuHistory.some(Boolean)) {
                            this.menu = this.menuHistory.pop()
                        } else {
                            this.goHome()
                        }
                        return
                    }

                    let lastMenu = this.menuHistory.some(Boolean) ? this.menuHistory[this.menuHistory.length - 1] : null;

                    if (lastMenu == null ||
                        lastMenu.id !== this.menu.id
                    ) {
                        this.menuHistory.push(this.menu)
                    }

                    fetchWrapper
                        .get('Menu/' + id)
                        .then((data) => {
                            if (data.menuItems.length === 0) {
                                data.menuItems.push({ "name": "Prev. menu", "function": "", "seq": 3, "nextMenuId": -2, "startMenuId": 0 })
                                if (this.view.isDated) {
                                    data.menuItems.push({ "name": "Up screen", "function": "2", "seq": 1, "nextMenuId": 0, "startMenuId": 0 })
                                    data.menuItems.push({ "name": "Down screen", "function": "3", "seq": 2, "nextMenuId": 0, "startMenuId": 0 })
                                }
                            }
                            this.menu = data
                        })
                        .catch((error) => console.error(error));
                }
            },
            goHome() {
                this.menu = JSON.parse(JSON.stringify(this.userStarter.menu));
                this.menuHistory = []
                this.setEntityType(this.entityTypes.find(t => t.id == this.userStarter.entityTypeId))
                this.setIndexType(this.entityType.indexTypes.find(t => t.id == this.userStarter.indexTypeId))
                this.mode = 1
                this.viewSearch = ""
                this.isAdvanced = false
            },
            doMenuItem(item) {
                item.isSelected = true
                let timer = setTimeout(() => {
                    item.isSelected = false
                }, 500);
                switch (item.function) {
                    case 'SCRN':
                        this.setView(this.entityType.views.find(v => v.id == item.parameter1))
                        break;
                    case 'CHGE':
                        this.setEntityType(this.entityTypes.find(e => e.id == item.parameter1))
                        break;
                    case '1':
                        let page = window.prompt('go to page:')
                        if (page > 0 && page <= this.nPages) {
                            this.page = page - 1
                        }
                        break;

                    case '2':
                        this.previousPage()
                        break;

                    case '3':
                        this.nextPage()
                        break;
                    default:
                    // code block
                }
                if (item.nextMenuId !== 0) {
                    this.getMenu(item.nextMenuId)
                } else if (item.startMenuId !== 0) {
                    this.getMenu(item.startMenuId)
                }
            },
            setAdvanced() {
                if (!this.isAdvanced) {
                    this.isAdvanced = true
                    this.menu = JSON.parse('{ "id":0, "name":"ADVANCED","menuItems":[]}')
                    this.mode = 2
                    this.getViews()
                    if (this.view.isDated && this.menu.menuItems.length === 0) {
                        this.menu.menuItems.push({ "name": "Up screen", "function": "2", "seq": 1, "nextMenuId": 0, "startMenuId": 0 })
                        this.menu.menuItems.push({ "name": "Down screen", "function": "3", "seq": 2, "nextMenuId": 0, "startMenuId": 0 })
                    }
                }
            },
            clear() {
                this.view = {}
                this.idValues = []
                this.values = []
            },
            keydown(e) {
                switch (e.key) {
                    case "Escape":
                        this.logout()
                        break
                    case "ArrowUp":
                        this.previousIndex()
                        return;
                    case "ArrowDown":
                        this.nextIndex()
                        return;
                    case "PageUp":
                        this.previousPage()
                        return;
                    case "PageDown":
                        this.nextPage()
                        return;
                    case "Enter":
                        this.goHome()
                        return;
                    case "HOME":
                        this.goHome()
                        return
                    case "0":
                        let timer = setTimeout(() => {
                            document.getElementById("#searchEntity").focus();
                        }, 500);
                        return
                    default:
                }

                if (Number.isNaN(e.key)) return
                let keyMap = [6, 7, 8, 3, 4, 5, 0, 1, 2]
                let menuId = keyMap[e.key - 1]
                if (menuId === undefined) return
                let menuItem = this.menu.menuItems.find(i => i.seq == menuId)
                if (menuItem === undefined) {
                    return;
                }
                if (menuItem !== null) {

                    document.getElementById("#searchEntity").blur();
                    this.doMenuItem(menuItem)
                }
            },
            viewCaption(text) {
                if (this.viewSearch.length > 0) {
                    let reg = new RegExp(`${this.viewSearch}`, 'gi');

                    return text.replace(reg, "<tspan>$&</tspan>")
                }
                return text
            }

        })

        createApp({ app }).mount()

        var indexTimer
        var loginTimer

        function resetLoginTimer() {

            if (loginTimer) {
                clearTimeout(loginTimer)
            }
            loginTimer = setTimeout(() => {
                app.logout()
                location.reload();
            }, 900000);
        }

        class FetchWrapper {
            constructor(baseUrl) {
                this.baseUrl = baseUrl;
                this.token = null;
            }

            async get(url) {
                if (this.token == null) return;
                resetLoginTimer()
                const response = await fetch(`${this.baseUrl}${url}`,
                    {
                        method: 'get',
                        headers: {
                            'Accept': 'application/json, text/plain, */*',
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + this.token,
                        }
                    });
                this.status = response.status;
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            }


            async put(url, data) {
                const response = await fetch(`${this.baseUrl}${url}`, {
                    method: 'PUT',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                if (!response.ok) {
                    console.log(response.status);
                }
                return response.json();
            }

            async post(url, data) {
                const response = await fetch(`${this.baseUrl}${url}`, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                if (!response.ok) {
                    console.log(response.status);
                    return;
                }
                resetLoginTimer()
                return response.json();
            }

            async delete(url) {
                const response = await fetch(`${this.baseUrl}${url}`, {
                    method: 'DELETE',
                });
                return response.json();
            }
        }

        const fetchWrapper = new FetchWrapper(window.location);


    </script>
</head>

<body v-scope="app" @keydown="keydown">

    <svg viewBox="0 0 160 480" class="nav"  preserveAspectRatio="none" v-show="mode>0"
         font-size="16.6666666">

        <line x1="160" y1="0" x2="160" y2="480"></line>

        <g v-show="mode==1">
            <text class="caption" x="10" y="20">Select {{entityType.name}}</text>

            <foreignObject x="10" y="30" width="180" height="30">
                <input type="text" v-model="indexSearch" width="170" autocomplete="off"
                       @keyup.self="indexSearchChanged" @input="indexSearchChanged"
                       :placeholder="indexType.name" id="#searchEntity" />
            </foreignObject>

            <text v-for="(i, ix) in indexes" class="input"
                  x="10" :y="ix*20 + 80" v-bind:class="[(i.entityId == entityId) ? 'selected' : 'input']"
                  @click="setEntity(i.entityId)">{{i.term}}</text>

            <text class="caption clickable" @click="getIndexPreviousPage" x="10" y="470" v-show="indexesPage>0">&lt;BACK</text>
            <text class="caption clickable" @click="getIndexNextPage" x="110" y="470" v-show="indexes.length==19">NEXT&gt;</text>

        </g>

        <g v-show="mode==2">

            <text class="caption" x="10" y="20">Select view</text>

            <foreignObject x="10" y="30" width="180" height="30">
                <input type="text" v-model="viewSearch" @keyup="getViews"
                        @input.self="getViews" width="170" autocomplete="off" placeholder="enter text" />
            </foreignObject>
            <text v-for="(v, ix) in views.slice(viewStart, viewEnd)" class="input"
                    x="10" :y="ix*20+80" v-bind:class="[(v == view) ? 'selected' : 'input']"
                    @click="setView(v)">
                {{v.name}}
            </text>
            <text class="caption clickable" @click="viewsPage--" x="10" y="470" v-show="viewsPage>0">&lt;BACK</text>
            <text class="caption clickable" @click="viewsPage++" x="110" y="470" v-show="(viewEnd<views.length)">NEXT&gt;</text>
        </g>

        <g v-show="mode==3" >

            <text class="caption" x="10" y="20">Select entity type</text>

            <text v-for="(t, index) in entityTypes" class="input"
                    x="10" :y="index*20 + 60" v-bind:class="[(t.id == entityType.id) ? 'selected' : 'input']"
                    @click="setEntityType(t)">{{t.name}}</text>

        </g>

        <g v-show="mode==4">

            <text class="caption" x="10" y="20">Select index type</text>

            <text v-for="(t, ix) in entityType.indexTypes.slice(indexTypePage * 19 , indexTypePage * 19 + 19)"
                    x="1" :y="ix*20 + 60" v-bind:class="[(t == indexType) ? 'selected' : 'input']"
                    @click="setIndexType(t)">{{t.name}}</text>

            <text class="caption clickable" @click="indexTypePage--" x="10" y="470" v-show="indexTypePage>0">&lt;BACK</text>
            <text class="caption clickable" @click="indexTypePage++" x="110" y="470" v-show="(indexTypePage * 19 + 19 ) < entityType.indexTypes.length">NEXT&gt;</text>

        </g>
        <g v-show="mode==5" font-size="12">
            <g v-show="loadMessage">
                <text>{{loadMessage}}</text>
            </g>
            <g v-else>
                <text class="caption" x="2" y="20">View ID:{{view.id}}</text>
                <text class="caption" x="2" y="40">{{attributeConfig.id}}:{{attributeConfig.name}}</text>
                <text class="caption" x="2" y="60">{{attributeConfig.comment}}</text>
                <text class="caption" x="2" y="80">{{attributeConfig.dataType}}</text>
                <text class="caption" x="2" y="100">max:{{attributeConfig.max}} min:{{attributeConfig.min}}</text>
                <text class="caption" x="2" y="120" v-show="attributeConfig.quark">Quark:{{attributeConfig.quark}}</text>

                <g v-show="attributeConfig.lookups.length > 0">
                    <text class="caption" x="2" y="120">Lookup type:</text>
                    <text class="caption" x="2" y="140">{{attributeConfig.lookupType}}</text>
                    <text v-for="(l ,ix) in attributeConfig.lookups" class="value" x="2" :y="180+ix*20">{{l.name}}</text>

                    <text class="caption clickable" @click="previousLookups" x="10" y="470" v-show="lookupsPage>0">&lt;BACK</text>
                    <text class="caption clickable" @click="nextLookups" x="110" y="470" v-show="attributeConfig.lookups.length==14">NEXT&gt;</text>

                </g>

                
            </g>
        </g>
    </svg>

    <!--The main view. reprersenting a 5:3 aspect rato. 80 caracters wide
        24 lines of characters, double line spacing = 48 characters high
        monospace font also has 5:3 aspect ratio (1.6666)
        set font size 1.66666 so character width=1/80 screen width  -->

    <svg viewBox="0 0 80 48" class="main" preserveAspectRatio="none"
            font-size="1.6666666" v-show="mode>0">
        <line x1="0" y1="3" x2="80" y2="3"></line>
        <line x1="0" y1="41" x2="80" y2="41"></line>
        <line x1="40" y1="41" x2="40" y2="48"></line>
        <line x1="0" y1="0" x2="0" y2="48"></line>
        <text class="caption" v-for="c in view.captions" :x="c.x" :y="c.y*2" v-html="viewCaption(c.text)"></text>
        <text class="value" v-for="v in idValues" :x="v.x" :y="(v.y-3)*2">{{v.text}}</text>
        <text class="value" v-for="v in values" :x="v.x" :y="v.y*2">{{v.text}}</text>
        <rect v-for="a in view.viewAttributes" :height="(view.nRows) * 2 - 0.33333" :width="a.displayLength" 
              :class="[isConfig? a.attributeId==attributeConfig.id? 'selected':'config':  'clickable']"
              :x="a.x" :y="(a.y)*2-1.33333 " @click="graph(a.attributeId)" />
        <text v-show="nPages>1" class="value" x="26" y="43">{{page + 1}}/{{nPages}}</text>
        <g v-show="isAdvanced">
            <text :class="[(mode==1)? 'selected': 'input']" x="1" y="45" @click="mode=1">Select by {{indexType.name}}</text>
            <text :class="[(mode==2)? 'selected': 'input']" x="1" y="47" @click="mode=2">View</text>
            <text :class="[(mode==3)? 'selected': 'input']" x="17" y="47" @click="mode=3">Entity</text>
            <text :class="[(mode==4)? 'selected': 'input']" x="33" y="47" @click="mode=4">Index</text>
            <g @click="isConfig=!isConfig" class="clickable">
                <svg viewBox="0 0 100 100" x="17" y="41.9" width="1.2" height="1.2">

                    <rect x="0" y="0" height="100" width="100" fill="white" stroke="black" stroke-width="5" />
                    <polyline v-show="isConfig" points="0,50 40,100 100,0"
                              style="fill:none;stroke:red;stroke-width:20" />
                </svg>
                <text x="19" y="43" :class="[(isConfig)? 'selected': 'input']" >config</text>
            </g>

        </g>
        <text class="input" x="33" y="43" @click="logout">Logout</text>
        <text :class="[!isAdvanced? 'caption clickable': 'input']" x="33" y="45" @click="goHome">Home</text>

        <text class="caption" x="1" y="43">{{menu.name}}</text>
        <text :class="[i.isSelected? 'selected': 'input']" v-for="i in menu.menuItems"
                :y="Math.floor(i.seq / 3) * 2 + 43"
                :x="(i.seq % 3) * 13 + 41" @click="doMenuItem(i)">{{i.name}}</text>

        <text v-show="!isAdvanced" class="input" x="1" y="47" @click="setAdvanced">Advanced</text>

    </svg>
    <svg v-show="mode==0" viewBox="0 0 960 480" class="login" preserveAspectRatio="none"
            font-size="17">
        <text x="20" y="60" class="caption">Proton password:</text>
        <foreignObject x="170" y="40" width="180" height="30">
            <input type="password" v-model="pwd" width="170" autocomplete="off" @keydown.enter="tryLogin" />
        </foreignObject>
        <g @click="tryLogin">
            <rect x="360" y="40" width="100" height="30" class="button" fill="white" />
            <text x="380" y="60" class="button">submit</text>
        </g>
        <text class="caption" x="20" y="100">{{loginMessage}}</text>
    </svg>

    <style>
        svg {
            height: 100vh;
            display: block;
            font-family: Fira Code, monospace;
        }

        tspan {
            fill: palevioletred;
            font-weight: bold;
            text-decoration: underline;
        }

        svg.nav {
            width: 20%;
            float: left;
            background-color: midnightblue;
        }

        svg.main {
            width: 80%;
            float: right;
            background-color: navy;
        }

        svg.login {
            width: 100%;
            float: right;
            background-color: navy;
        }

        line {
            stroke: grey;
            stroke-width: 0.1;
        }

        text.value {
            fill: white;
        }

        text.input {
            fill: grey;
            cursor: pointer;
        }

        rect.config {
            opacity: 0.2;
            fill: aqua;
            cursor: pointer;
        }
        rect.selected {
            opacity: 0.2;
            fill: red;
            cursor: pointer;
        }
        rect.clickable {
            opacity: 0;
            cursor: pointer;
        }

        .clickable {
            cursor: pointer;
        }
        rect.button {
            fill: lightgray;
            stroke: black;
            stroke-width: 4px;
            cursor: pointer;
        }

        text.clickable {
            cursor: pointer;
        }

        text.button {
            cursor: pointer;
            fill: black;
        }

        text.selected {
            fill: yellow;
        }

        text.caption {
            fill: yellow;
        }

        [contenteditable] {
            outline: 0px solid transparent;
        }

        input {
            outline: 0px solid transparent;
        }

        p.input {
            background-color: white;
        }
    </style>
</body>
</html>