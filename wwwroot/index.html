<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Photon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href='https://fonts.googleapis.com/css?family=Amaranth' rel='stylesheet'>

    <script type="module" src="./main.js"></script>
</head>

<body v-scope="app" @keydown="keydown">

    <!--The tools view  -->
    <svg viewBox="0 0 160 480" class="nav" preserveAspectRatio="none" v-if="mode>0"
         font-size="16.6666666">

        <line x1="160" y1="0" x2="160" y2="480"></line>

        <!--select entity  -->
        <g v-show="mode==1">
            <text class="caption" x="10" y="20">Select {{entityType.name}}</text>

            <foreignObject x="10" y="30" width="180" height="30">
                <input type="text" v-model="indexSearch" width="170" autocomplete="off"
                       @keyup.self="indexSearchChanged" @input="indexSearchChanged"
                       :placeholder="indexType.name" id="#searchEntity" />
            </foreignObject>

            <text v-for="(i, ix) in indexes" class="input"
                  x="10" :y="ix*20 + 80" v-bind:class="[(i.entityId == entityId) ? 'selected' : 'input']"
                  @click="setEntity(i.entityId)">{{i.term}}</text>

            <text class="caption clickable" @click="getIndexPreviousPage" x="10" y="470" v-show="indexesPage>0">&lt;BACK</text>
            <text class="caption clickable" @click="getIndexNextPage" x="110" y="470" v-show="indexes?.length==19">NEXT&gt;</text>

        </g>

        <!--select view  -->
        <g v-show="mode==2">

            <text class="caption" x="10" y="20">Select view</text>

            <foreignObject x="10" y="30" width="180" height="30">
                <input type="text" v-model="viewSearch" @keyup="getViews"
                       @input.self="getViews" width="170" autocomplete="off" placeholder="enter text" />
            </foreignObject>
            <text v-for="(v, ix) in views.slice(viewStart, viewEnd)" class="input"
                  x="10" :y="ix*20+80" v-bind:class="[(v == view) ? 'selected' : 'input']"
                  @click="setView(v)">
                {{v.name}}
            </text>
            <text class="caption clickable" @click="viewsPage--" x="10" y="470" v-show="viewsPage>0">&lt;BACK</text>
            <text class="caption clickable" @click="viewsPage++" x="110" y="470" v-show="(viewEnd<views?.length)">NEXT&gt;</text>
        </g>

        <g v-show="mode==3">

            <text class="caption" x="10" y="20">Select entity type</text>

            <text v-for="(t, index) in entityTypes" class="input"
                  x="10" :y="index*20 + 60" v-bind:class="[(t.id == entityType.id) ? 'selected' : 'input']"
                  @click="setEntityType(t)">{{t.name}}</text>

        </g>

        <g v-show="mode==4">

            <text class="caption" x="10" y="20">Select index type</text>

            <text v-for="(t, ix) in entityType.indexTypes.slice(indexTypePage * 19 , indexTypePage * 19 + 19)"
                  x="1" :y="ix*20 + 60" v-bind:class="[(t == indexType) ? 'selected' : 'input']"
                  @click="setIndexType(t)">{{t.name}}</text>

            <text class="caption clickable" @click="indexTypePage--" x="10" y="470" v-show="indexTypePage>0">&lt;BACK</text>
            <text class="caption clickable" @click="indexTypePage++" x="110" y="470" v-show="(indexTypePage * 19 + 19 ) < entityType.indexTypes?.length">NEXT&gt;</text>

        </g>

        <!--attribute config view  -->
        <g v-show="mode==5" font-size="12">
            <g v-show="loadMessage">
                <text>{{loadMessage}}</text>
            </g>
            <g v-else>
                <text class="caption" x="2" y="20">View ID: {{view.id}}</text>
                <text class="caption" x="2" y="35">Attribute: {{attributeConfig.id}}: {{attributeConfig.name}}</text>
                <text class="caption" x="2" y="50">{{attributeConfig.comment}}</text>
                <text class="caption" x="2" y="65">max: {{attributeConfig.max}} min: {{attributeConfig.min}}</text>
                <text class="caption" x="2" y="80">{{entityType?.name}}s: {{attributeUse.nEntities}}</text>
                <text class="caption" x="2" y="95">Per {{entityType?.name}}: {{attributeUse.perEntity}}</text>
                <text class="caption" x="2" y="110">Most recent: {{attributeUse.latest}}</text>
                <text class="caption" x="2" y="125">Type: {{attributeConfig.dataType}}</text>

                <text class="caption" x="2" y="140" v-show="attributeConfig.quark">Quark: {{attributeConfig.quark}}</text>

                <g v-show="attributeConfig.lookups?.length > 0">
                    <text class="caption" x="2" y="140">Lookup type:</text>
                    <text class="caption" x="2" y="155">{{attributeConfig.lookupType}}</text>
                    <text v-for="(l ,ix) in attributeConfig.lookups" class="value" x="2" :y="170+ix*15">{{l.name}}</text>

                    <text class="caption clickable" @click="previousLookups" x="10" y="470" v-show="lookupsPage>0">&lt;BACK</text>
                    <text class="caption clickable" @click="nextLookups" x="110" y="470" v-show="attributeConfig.lookups?.length==20">NEXT&gt;</text>

                </g>


            </g>
        </g>
    </svg>

    <!--The main view. reprersenting a 5:3 aspect rato. 80 caracters wide
        24 lines of characters, double line spacing = 48 characters high
        monospace font also has 5:3 aspect ratio (1.6666)
        set font size 1.66666 so character width=1/80 screen width  -->

    <svg viewBox="0 0 80 48" class="main" preserveAspectRatio="none"
         font-size="1.6666666" v-if="mode>0">
        <line x1="0" y1="3" x2="80" y2="3"></line>
        <line x1="0" y1="41" x2="80" y2="41"></line>
        <line x1="40" y1="41" x2="40" y2="48"></line>
        <line x1="0" y1="0" x2="0" y2="48"></line>
        <text class="value" v-for="v in idValues" :x="v.x" :y="(v.y-3)*2">{{v.text}}</text>
        
        <g v-show="!graphAttribute">
            <!--Tabular area-->
            <text class="caption" v-for="c in view.captions" :x="c.x" :y="c.y*2" v-html="viewCaption(c.text)"></text>
            <text class="value" v-for="v in values" :x="v.x" :y="v.y*2">{{v.text}}</text>
            <rect v-for="a in view.viewAttributes" :height="(view.nRows) * 2 - 0.33333" :width="a.displayLength"
                  :class="selectTargetClass(a)"
                  :x="a.x" :y="(a.y)*2-1.33333 " @click="graph(a)">
               <title>{{selectTooltip(a)}}</title>
            </rect> />
            <text v-show="nPages>1" class="value" x="26" y="43">{{page + 1}}/{{nPages}}</text>
            <text class="caption" x="1" y="43">{{menu?.name}}</text>
            <text :class="[i.isSelected? 'selected': 'input']" v-for="i in menu.menuItems"
                  :y="Math.floor(i.seq / 3) * 2 + 43"
                  :x="(i.seq % 3) * 13 + 41" @click="doMenuItem(i)">{{i.name}}</text>
        </g>
        <g v-show="graphAttribute">
            <!-- graph area -->
            <svg x="0" y="3" width="80" height="38"
                 viewBox="0 0 80 34" preserveAspectRatio="none" class="outer" >
                <g v-show="graphData.plotPath.trim() != ''">
                    <rect width="100%" height="100%" class="outer" />
                    <!-- plot area -->
                    <svg viewBox="0 0 65 30" x="10" y="0" height="30" width="65"
                         class="plotArea" preserveAspectRatio="none">
                        <rect width="100%" height="100%" class="plotArea" />
                        <polyline :points="graphData.plotPath" />
                        <!-- gridlines -->
                        <line v-for="c in graphData.xCaptions1" y1="0" y2="34" :x1="c.x" :x2="c.x" class="grid"></line>
                        <line v-for="c in graphData.yCaptions" :y1="c.y" :y2="c.y" x1="0" x2="70" class="grid"></line>
                    </svg>
                    <!-- Y scale -->
                    <svg x="0" y="0" height="30" width="10" viewBox="0 0 10 30" class="axis" preserveAspectRatio="none">
                        <text text-anchor="end" v-for="c in graphData.yCaptions" :y="c.y" x="9.8" class="axis">
                            {{c.text}}
                        </text>
                    </svg>
                    <!-- X scale -->
                    <svg x="10" y="30" width="75" height="4" viewBox="0 0 75 4" class="axis" preserveAspectRatio="none">
                        <line v-for="c in graphData.xCaptions2" y1="0" y2="4" :x1="c.x" :x2="c.x" class="grid"></line>
                        <text v-for="c2 in graphData.xCaptions2" y="3.6" :x="c2.x" class="axis">
                            {{c2.text}}
                        </text>
                        <text v-for="c1 in graphData.xCaptions1" y="1.6" :x="c1.x" class="axis">
                            {{c1.text}}
                        </text>
                    </svg>
                </g>
                <g v-show="graphData.plotPath.trim() == ''">
                    <text class="axis" x="37" y="20"> No data</text>
                </g>
            </svg>
            <text class="caption" x="41" y="43">Graphing {{graphAttribute?.name}}</text>
            <text v-show="graphData.zoomFraction < 1" class="input" x="41" y="45" @click="graphZoom(1)">Zoom out</text>
            <text v-show="graphData.zoomFraction > 0" class="input" x="54" y="45" @click="graphZoom(-1)">Zoom in</text>
            <text class="input" x="67" y="47" @click="graphAttribute=null">Finished</text>
        </g>
        <g v-show="isAdvanced">
            <text :class="[(mode==1)? 'selected': 'input']" x="1" y="45" @click="mode=1">Select by {{indexType.name}}</text>
            <text :class="[(mode==2)? 'selected': 'input']" x="1" y="47" @click="mode=2">View</text>
            <text :class="[(mode==3)? 'selected': 'input']" x="17" y="47" @click="mode=3">Entity</text>
            <text :class="[(mode==4)? 'selected': 'input']" x="33" y="47" @click="mode=4">Index</text>
            <g @click="isConfig=!isConfig" class="clickable">
                <svg viewBox="0 0 100 100" x="17" y="41.9" width="1.2" height="1.2">

                    <rect x="0" y="0" height="100" width="100" fill="white" stroke="black" stroke-width="5" />
                    <polyline v-show="isConfig" points="0,50 40,100 100,0"
                                style="fill:none;stroke:red;stroke-width:20" />
                </svg>
                <text x="19" y="43" :class="[(isConfig)? 'selected': 'input']">config</text>
            </g>

        </g>
        <text class="input" x="33" y="43" @click="logout">Logout</text>
        <text :class="[!isAdvanced? 'caption clickable': 'input']" x="33" y="45" @click="goHome">Home</text>



        <text v-show="!isAdvanced" class="input" x="1" y="47" @click="setAdvanced">Advanced</text>

    </svg>

    <!-- log in -->
    <svg v-if="mode==0" viewBox="0 0 960 480" class="login" preserveAspectRatio="none"
         font-size="17">
        <text x="20" y="60" class="caption">Proton password:</text>
        <foreignObject x="170" y="40" width="180" height="30">
            <input type="password" v-model="pwd" width="170" autocomplete="off" @keydown.enter="tryLogin" />
        </foreignObject>
        <g @click="tryLogin">
            <rect x="360" y="40" width="100" height="30" class="button" fill="white" />
            <text x="380" y="60" class="button">submit</text>
        </g>
        <text class="caption" x="20" y="100">{{loginMessage}}</text>
    </svg>

    <style>
        line.grid {
            stroke-width: 0.1;
            stroke: grey;
        }

        svg.outer {
            background-color: navy;
        }

        text.axis {
            fill: white;
            font-size: 1.6666;
        }

        svg polyline {
            stroke-width: 0.2;
            fill: none;
            stroke: red;
        }

        rect.outer {
            fill: navy;
        }

        rect.plotArea {
            fill: hsl(from navy h s calc(l + 10));
            stroke: white;
            stroke-width: 0.2;
        }
        svg {
            height: 100vh;
            display: block;
            font-family: Fira Code, monospace;
        }

        tspan {
            fill: palevioletred;
            font-weight: bold;
            text-decoration: underline;
        }

        svg.nav {
            width: 20%;
            float: left;
            background-color: midnightblue;
        }

        svg.main {
            width: 80%;
            float: right;
            background-color: navy;
        }

        svg.login {
            width: 100%;
            float: right;
            background-color: navy;
        }

        line {
            stroke: grey;
            stroke-width: 0.1;
        }

        text.value {
            fill: white;
        }

        text.input {
            fill: grey;
            cursor: pointer;
        }

        rect.config {
            opacity: 0.2;
            fill: aqua;
            cursor: pointer;
        }

        rect.selected {
            opacity: 0.2;
            fill: red;
            cursor: pointer;
        }

        rect.hidden {
            opacity: 0;
        }

        rect.clickable {
            opacity: 0;
            cursor: pointer;
        }

        .clickable {
            cursor: pointer;
        }

        rect.button {
            fill: lightgray;
            stroke: black;
            stroke-width: 4px;
            cursor: pointer;
        }

        text.clickable {
            cursor: pointer;
        }

        text.button {
            cursor: pointer;
            fill: black;
        }

        text.selected {
            fill: yellow;
        }

        text.caption {
            fill: yellow;
        }

        [contenteditable] {
            outline: 0px solid transparent;
        }

        input {
            outline: 0px solid transparent;
        }

        p.input {
            background-color: white;
        }

    </style>
</body>
</html>